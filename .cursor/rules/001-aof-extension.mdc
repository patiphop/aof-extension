---
description: "Project-wide rules for aof-extension (VS Code extension + Node server)"
alwaysApply: true
globs:
  - "**/*.ts"
  - "**/*.tsx"
  - "server/**/*.ts"
---

## Overview
- **Stack**: VS Code Extension (TypeScript, Webpack), Node server (TypeScript), WebSocket via `ws`, Vitest, ESLint.
- **Entry points**: `src/extension.ts` (extension), `server/src/server.ts` (server).
- **Key services**: `src/services/SyncManager.ts`, `src/services/WebSocketClient.ts`.
- **Key utils**: `src/utils/FileScanner.ts`, `src/utils/GitignoreParser.ts`, `src/utils/Logger.ts`.

## Commands & Scripts
- Root: `bundle`, `watch`, `compile`, `lint`, `test`, `test:watch`, `test:coverage`, `build`.
- Server: `build`, `dev`, `test`, `test:coverage`.

## Architectural Rules
- Extension lifecycle via `activate`/`deactivate`. Register commands in `activate` and push disposables to `context.subscriptions`.
- Sync flow: file events → `SyncManager.syncFile`/`deleteFile` → `WebSocketClient.send*` → server. Server events → `SyncManager.handleServerMessage` → local FS ops + events.
- Path handling: normalize to forward slashes in protocol payloads; use `path.join` for local paths; never assume POSIX.
- `.gitignore` semantics: use `GitignoreParser.loadAllGitignores` and negation handling; directory patterns with trailing `/` must be treated as directories.
- Networking: messages are JSON `{ type, payload? }`. Reconnect must be bounded and idempotent.
- Logging: use the `logger` singleton; in extension mode prefer `logger.extension`, `logger.sync`, `logger.connection`. Avoid noisy logs.

## Coding Conventions
- TypeScript strictness; explicit types for public APIs; avoid `any`.
- Early returns, shallow nesting, guard clauses.
- Naming: verbs for functions, nouns for classes, descriptive variable names; avoid nonstandard abbreviations.
- Error handling: wrap IO/network, include context, never swallow errors.
- Events: typed payloads, minimal side-effects in handlers.
- Formatting: match existing style; do not reformat unrelated code in edits.

## Testing
- Add/update tests for features and bug fixes. Focus on: path normalization, gitignore precedence, text vs binary detection, reconnect bounds.
- Ensure `npm test` passes; use coverage as needed.
- Utils get unit tests; `WebSocketClient`/`SyncManager` use event-driven tests with stubs/mocks.

## Safety & Compatibility
- Do not change command IDs: `faizsync.startSync`, `faizsync.stopSync`, `faizsync.openWebView`.
- Do not change protocol types silently: `SYNC_FILE`, `DELETE_FILE`, `CLEAR_FOLDER`, server `FILE_*`, `FOLDER_CLEARED`. If changing, version the protocol.
- Filesystem: create parent directories before writes; avoid destructive ops unless requested by server message.
- WebSocket URL currently hardcoded; if adding config, keep default and document migration.

## Performance
- Scanning must short-circuit when root is missing; log directory scan errors individually.
- Skip binary files by extension; treat unknown/no-extension as text only when safe.
- Watchers: process only within selected folder; debounce/throttle bursts if bulk operations are added.

## Extension UX
- Use `vscode.window.show*Message` sparingly (start/stop, connected/disconnected, conflicts). Use progress where operations are long.

## Editing Workflow (for AI)
- Always follow these rules.
- Before edits: scan impacted files; keep edits minimal and localized.
- After edits: run tests; fix failures; ensure lints pass.
- Keep imports tidy; add missing, remove unused.
- Preserve indentation style; never reindent unrelated lines.

## Playbooks
- New config (e.g., WS URL): add setting/env with default, thread via `SyncManager` ctor, add tests.
- New server message: extend types and switch in `handleServerMessage`, implement handler like `handleFile*`, emit events, add tests.
- Scanning perf: profile `scanFiles`, reduce sync IO in hot paths, keep `.gitignore` behavior; add tests.

## References
- `src/extension.ts`, `src/services/SyncManager.ts`, `src/services/WebSocketClient.ts`, `src/utils/FileScanner.ts`, `src/utils/GitignoreParser.ts`, `src/utils/Logger.ts`, `server/`.